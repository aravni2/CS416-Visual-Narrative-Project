<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
<style> 
    rect {
        fill: lightblue; 
        stroke: blue;
        } 
    
    #tooltip {
        opacity: 0;
        position:absolute;
        text-align: center;
        width: 150px;
        height: 100px;
        background-color: whitesmoke;
        color: black;
        border: 0px;
        border-radius: 10px;
        /* display: none;  */
        
    }

</style>

<body onload='init()'>  
<svg class="chart" width=2100 height=1200></svg>
<!-- <div id="sliderbar"></div> -->
<div id="tooltip"></div> 
<button id="bt1" type="button" onclick="">Click Me!</button>
<!-- <button id="bt1" type="button" onclick="createGraph(dataslice,data,index)">Click Me!</button> -->

<script>
let gwidth = 2000 //scale for width of chart in pixels
let gheight = 1100 //scale for hight of chart in pixels
let margin = 50;
let sliderwidth = 300;
var index = 0;
const type = d3.annotationCalloutElbow;
//async function to first call data download before moving to next functions
async function init() {
    // const data = await d3.csv('http://localhost:8000/DJA and GDP Cleaned.csv'); //await data load
    const data = await d3.csv('https://raw.githubusercontent.com/aravni2/CS416-Visual-Narrative-Project/main/DJA%20and%20GDP%20Cleaned.csv'
    ); //await data load
    console.log(data)
    let xs = d3.scaleLinear().domain(d3.extent(data,d=>+d.Year)).range([0,gwidth]);
    let ys = d3.scaleLinear().domain([0,d3.max(data,d=>+d['DJIA Avg. Adj'])]).range([gheight,0]);
    console.log(d3.max(data,d=>+d['DJIA Avg. Adj']))

    let y_axis = d3.axisLeft(ys).tickFormat(d3.format("$~s")); //set up y_axis ticks and number format
    let x_axis = d3.axisBottom(xs)
        .ticks(50)
        .tickFormat(d3.format("")); //setup x_axis ticks and number formats

    var tooltip = d3.select("#tooltip"); 
    var dataslice = data.slice(0,index+50)
    //bind data load to scatter plots and scale radii to adjusted

    function createGraph(dataslice,data,index){
    d3.select('.chart')
        .append('g').attr("transform","translate("+margin+","+margin+")") //start at canvas
        .selectAll("circle")
        .data(dataslice)
        .enter()
        .append("circle")
        .attr("cx",(d,i)=> xs(+d.Year)) //cx
        .attr("cy", (d)=> ys(+d['DJIA Avg. Adj'])) //cy
        .attr("r",4) //need to convert data values of radii from string to integer (otherwise concatenation)
        .on("mouseover",function(d,i) {

            tooltip.style("opacity",1)
            .style("left",(d3.event.pageX)+10+"px")
            .style("top",(d3.event.pageY)+"px")
            // .html("Dow Jones Industrial Average: <strong>"+d['DJIA Avg. Adj']+"<strong/>\n Change: <strong/><span style='color: green;'>"+d['DJA YoY Growth'] )
            .html(function() { 
                if (+d['DJA YoY Growth'] > 0 ) {
                    // console.log(d['DJA YoY Growth'])
                    return "Year:" +d.Year+ "<br/>Dow Jones Industrial Average: <strong>"+d['DJIA Avg. Adj']+"<strong/> <br>Change: <strong/><span style='color: green;'>"+d['DJA YoY Growth']+"%" ;
            } else if (+d['DJA YoY Growth'] < 0 ) {
                    return "Year:" +d.Year+ "<br/>Dow Jones Industrial Average: <strong>"+d['DJIA Avg. Adj']+"<strong/><br> Change: <strong/><span style='color: red;'>"+d['DJA YoY Growth']+"%"  ;
            } else {
                    return "Year:" +d.Year+ "<br/>Dow Jones Industrial Average: <strong>"+d['DJIA Avg. Adj']+"<strong/><br> Change: <strong/><span style='color: black;'>"+d['DJA YoY Growth']+"%" ;
            }
    });
        d3.select(this).attr("r",8);}
        )
      
        .on("mouseout",function(d){
            tooltip.style("opacity",0);
            d3.select(this).attr("r",4);
        });


    

    const line = d3.line()

        .x(d=>xs(+d.Year))
        .y(d=>ys(+d['DJIA Avg. Adj']));
    

    const type = d3.annotationCalloutElbow

    const annotations = [{
    note: {
        label: "Longer text to show text wrapping",
        title: "Annotations :)"
    },
    //can use x, y directly instead of data
    data: { Year: 1952, "DJIA Avg. Adj": 5000},
    dy: 60,
    dx: -60
    }]

    

    const makeAnnotations = d3.annotation()
    .editMode(true)
    //also can set and override in the note.padding property
    //of the annotation object
    .notePadding(15)
    .type(type)
    //accessors & accessorsInverse not needed
    //if using x, y in annotations JSON
    // DON'T FORGET MARGINS!!!!
    .accessors({
        x: d => xs(1929)+50,
        y: d => ys(5200)+50
    })
    .accessorsInverse({
        Year: d => x.invert(d.x),
        "DJIA Avg. Adj": d => y.invert(d.y)
    })
    .annotations(annotations);

    d3.select("svg")
    .append("g")
    .attr("class", "annotation-group")
    .call(makeAnnotations);


    // append line path to svg to connect dots
    d3.select("svg").append("path")
        .attr("transform","translate("+margin+","+margin+")")
        .datum(dataslice)
        .transition()
        .duration(1000)
        .attr("fill","none")
        .attr("stroke","steelblue")
        .attr("stroke-width",1)
        .attr("d", line);
    }    
    // finish setting y axis
    d3.select('svg').append("g")
        .style("font-size", "16px")
        .attr("transform","translate("+margin+","+margin+")")
        .call(y_axis);  //create y axis
    
    // create x axis
    d3.select('svg').append("g")
        .style("font-size", "14px")
        .attr("transform","translate("+margin+","+(gheight+margin)+")")
        .call(x_axis); //create x axis using y axis height to shift downwards

    // change tick color
    d3.select("svg").selectAll(".tick text").attr("fill", "grey");

    // add horizontal grid lines
    d3.select("svg").selectAll("yaxis")
        .data(ys.ticks(7).slice(1))
        .join("line")
        .attr("x1",margin)
        .attr("x2",gwidth+margin)
        .attr("y1",(d)=>ys(d)+50)
        .attr("y2",(d)=>ys(d)+50)
        .attr("stroke","grey")
        .attr("stroke-width",.5);
    
    // // add tooltips
    // var tooltip = d3.select("tooltip")
    
    // // add a circle element
    // const circle = svg.append("circle")
    // .attr("r",0)
    // .attr("fill","steelblue")
    // .style("stroke", "white")
    // .attr("opacity",.7)
    // .style("pointer-events","none");

    

    

    d3.select("#bt1").on("click", (d,i) => {
        index += 40;
        var dataslice = data.slice(0, index);
        createGraph(dataslice,data,index);
    })

    function updateGraph(newdata,data,index) {
        var dat = d3.select(".chart")
        .data(dataslice);
        dat.exit().remove();
        dat.enter()
        .append("g")
        .attr("class","dat")
        .merge(dat)

    }

    createGraph(dataslice,data)
}
</script>

</body>
</html>