<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
<style> 
    rect {
        fill: lightblue; 
        stroke: blue;
        } 
    
    #tooltip {
        opacity: 0;
        position:absolute;
        text-align: center;
        width: 150px;
        height: 100px;
        background-color: whitesmoke;
        color: black;
        border: 0px;
        border-radius: 10px;
        /* display: none;  */
        
    }

    #slider {
    width: 2000px;
    }
    #sliderdiv{
    padding-left: 40px;
    }


</style>

<body onload='init()'>  
<svg class="chart" width=2100 height=1200></svg>
<!-- <div id="sliderbar"></div> -->
<div id="tooltip"></div> 
<button id="bt1" type="button" onclick="">Click Me!</button>
<div id="sliderdiv"><input id="slider" type="range" min="1" max="115" step="1" value="1"/></div>
<!-- <button id="bt1" type="button" onclick="createGraph(dataslice,data,index)">Click Me!</button> -->

<script>
let gwidth = 2000 //scale for width of chart in pixels
let gheight = 1100 //scale for hight of chart in pixels
let margin = 50;
var index = 50;
const type = d3.annotationCalloutElbow;
//async function to first call data download before moving to next functions
async function init() {
    // const data = await d3.csv('http://localhost:8000/DJA and GDP Cleaned.csv'); //await data load
    const data = await d3.csv('https://raw.githubusercontent.com/aravni2/CS416-Visual-Narrative-Project/main/DJA%20and%20GDP%20Cleaned.csv'
    ); //await data load
    console.log(data)
    let xs = d3.scaleLinear().domain(d3.extent(data,d=>+d.Year)).range([0,gwidth]);
    let ys = d3.scaleLinear().domain([0,d3.max(data,d=>+d['DJIA Avg. Adj'])]).range([gheight,0]);
    console.log(d3.max(data,d=>+d['DJIA Avg. Adj']))

    let y_axis = d3.axisLeft(ys).tickFormat(d3.format("$~s")); //set up y_axis ticks and number format
    let x_axis = d3.axisBottom(xs)
        .ticks(50)
        .tickFormat(d3.format("")); //setup x_axis ticks and number formats

    var tooltip = d3.select("#tooltip"); 
    var dataslice = data.slice(0,index);
    console.log(dataslice);
    //bind data load to scatter plots and scale radii to adjusted

    function createGraph(dataslice,data,index){
    d3.select('.chart')
        .append('g').attr("transform","translate("+margin+","+margin+")") //start at canvas
        .selectAll("circle")
        .data(dataslice)
        .enter()
        .append("circle")
        .attr("cx",(d,i)=> xs(+d.Year)) //cx
        .attr("cy", (d)=> ys(+d['DJIA Avg. Adj'])) //cy
        .attr("r",4) //need to convert data values of radii from string to integer (otherwise concatenation)
        .on("mouseover",function(d,i) {

            tooltip.style("opacity",1)
            .style("left",(d3.event.pageX)+10+"px")
            .style("top",(d3.event.pageY)+"px")
            // .html("Dow Jones Industrial Average: <strong>"+d['DJIA Avg. Adj']+"<strong/>\n Change: <strong/><span style='color: green;'>"+d['DJA YoY Growth'] )
            .html(function() { 
                if (+d['DJA YoY Growth'] > 0 ) {
                    // console.log(d['DJA YoY Growth'])
                    return "Year:" +d.Year+ "<br/>Dow Jones Industrial Average: <strong>"+d['DJIA Avg. Adj']+"<strong/> <br>Change: <strong/><span style='color: green;'>"+d['DJA YoY Growth']+"%" ;
            } else if (+d['DJA YoY Growth'] < 0 ) {
                    return "Year:" +d.Year+ "<br/>Dow Jones Industrial Average: <strong>"+d['DJIA Avg. Adj']+"<strong/><br> Change: <strong/><span style='color: red;'>"+d['DJA YoY Growth']+"%"  ;
            } else {
                    return "Year:" +d.Year+ "<br/>Dow Jones Industrial Average: <strong>"+d['DJIA Avg. Adj']+"<strong/><br> Change: <strong/><span style='color: black;'>"+d['DJA YoY Growth']+"%" ;
            }
    });
        d3.select(this).attr("r",8);}
        )
      
        .on("mouseout",function(d){
            tooltip.style("opacity",0);
            d3.select(this).attr("r",4);
        });


    
    
    var line = d3.line()
        .x(d=>xs(+d.Year))
        .y(d=>ys(+d['DJIA Avg. Adj']));
    


    // append line path to svg to connect dots
    d3.select("svg").append("path")
        .attr("transform","translate("+margin+","+margin+")")
        .datum(dataslice)
        .transition()
        .duration(1000)
        .attr("fill","none")
        .attr("stroke","steelblue")
        .attr("stroke-width",1)
        .attr("d", line)
        .attr("class", "LineDraw");
    
    
    // needed multiple if statements to guarantee annotations don't come in piecewise
    // const type = d3.annotationCalloutElbow
    if (index < 51) {
    var annotations = [{
    note: {
        label: "Bob invests 5000 during the peak of the roaring twenties. Only to lose > 70% of his wealth in the coming Great depression",
        title: "The Great Depression"
    },
    //can use x, y directly instead of data
    data: { Year: 1929, "DJIA Avg. Adj": 5587},
    dy: -60,
    dx: 60
    }]
    } 
    if (index < 101 && index > 51) {
    var annotations = [
    {
    note: {
        label: "Bob invests 5000 during the peak of the roaring twenties. Only to lose > 70% of his wealth in the coming Great depression",
        title: "The Great Depression"
    },
    //can use x, y directly instead of data
    data: { Year: 1929, "DJIA Avg. Adj": 5587},
    dy: -60,
    dx: 60
    },
    {
    note: {
        label: "Bob invests another 5000 right before the 1987 flash crash. Only to lose another 14% in the following year",
        title: "1987 Flash Crash"
    },
    //can use x, y directly instead of data
    data: { Year: 1987, "DJIA Avg. Adj": 6109},
    dy: -60,
    dx: -60},
    {
    note: {
        label: "Bob feels computers are the way of the future.\n He invests another $5000 during the .com bubble peak and loses 38% in the next 3 years",
        title: "The Dot Com Bubble"
    },
    //can use x, y directly instead of data
    data: { Year: 1999, "DJIA Avg. Adj": 19169},
    dy: 60,
    dx: -65},
    {
    note: {
        label: "Recovering from his .com loss he invests another $5000 at the peak of the housing bubble",
        title: "The Housing Crisis"
    },
    //can use x, y directly instead of data
    data: { Year: 2007, "DJIA Avg. Adj": 19370},
    dy: -60,
    dx: -60}]
    }
    if (index >100) {
        var annotations = [
        {
    note: {
        label: "Bob invests 5000 during the peak of the roaring twenties. Only to lose > 70% of his wealth in the coming Great depression",
        title: "The Great Depression"
    },
    //can use x, y directly instead of data
    data: { Year: 1929, "DJIA Avg. Adj": 5587},
    dy: -60,
    dx: 60
    },
    {
    note: {
        label: "Bob invests another 5000 right before the 1987 flash crash. Only to lose another 14% in the following year",
        title: "1987 Flash Crash"
    },
    //can use x, y directly instead of data
    data: { Year: 1987, "DJIA Avg. Adj": 6109},
    dy: -60,
    dx: -60},
    {
    note: {
        label: "Bob feels computers are the way of the future.\n He invests another $5000 during the .com bubble peak and loses 38% in the next 3 years",
        title: "The Dot Com Bubble"
    },
    //can use x, y directly instead of data
    data: { Year: 1999, "DJIA Avg. Adj": 19169},
    dy: 60,
    dx: -65},
    {
    note: {
        label: "Recovering from his .com loss he invests another $5000 at the peak of the housing bubble",
        title: "The Housing Crisis"
    },
    //can use x, y directly instead of data
    data: { Year: 2007, "DJIA Avg. Adj": 19370},
    dy: -60,
    dx: -60},
    {
    note: {
        label: "Bob feels Covid is over and invests another $5000 at the end of 2021",
        title: "Post-Covid Inflation bubble"
    },
    //can use x, y directly instead of data
    data: { Year: 2021, "DJIA Avg. Adj": 38262},
    dy: 60,
    dx: -60}]
    }

    
    // create variables for animations
    const makeAnnotations = d3.annotation()
    .editMode(true)
    //also can set and override in the note.padding property
    //of the annotation object
    .notePadding(15)
    .type(type)
    //accessors & accessorsInverse not needed
    //if using x, y in annotations JSON
    // DON'T FORGET MARGINS!!!!
    .accessors({
        x: d => xs(d.Year)+50,
        y: d => ys(d['DJIA Avg. Adj'])+50
    })
    .accessorsInverse({
        Year: d => x.invert(d.x),
        "DJIA Avg. Adj": d => y.invert(d.y)
    })
    .annotations(annotations);


    d3.select("svg")
    .append("g")
    .attr("class", "annotation-group")
    .call(makeAnnotations);

    

}


    // finish setting y axis
    d3.select('svg').append("g")
        .style("font-size", "16px")
        .attr("transform","translate("+margin+","+margin+")")
        .call(y_axis);  //create y axis
    
    // create x axis
    d3.select('svg').append("g")
        .style("font-size", "14px")
        .attr("transform","translate("+margin+","+(gheight+margin)+")")
        .call(x_axis); //create x axis using y axis height to shift downwards

    // change tick color
    d3.select("svg").selectAll(".tick text").attr("fill", "grey");

    // add horizontal grid lines
    d3.select("svg").selectAll("yaxis")
        .data(ys.ticks(7).slice(1))
        .join("line")
        .attr("x1",margin)
        .attr("x2",gwidth+margin)
        .attr("y1",(d)=>ys(d)+50)
        .attr("y2",(d)=>ys(d)+50)
        .attr("stroke","grey")
        .attr("stroke-width",.5);
    


    // add title axis
    d3.select(".chart")
        .append("text")
        .attr("x", margin+gwidth/2)
        .attr("y",margin)
        .style("font-size", "20px")
        .style("font-weight", "bold")
        .style("font-family", "sans-serif")
        .text("Dow Jones Avg by year");

    
    // add button functionality
    d3.select("#bt1").on("click", (d,i) => {
        index += 50;
        var dataslice = data.slice(0, index);
        console.log(index);
        console.log(dataslice);
        createGraph(dataslice,data,index);

    })


    d3.select("#slider").on("input", function(d,i) {
        index = this.value;
        console.log(this.value)
        console.log(index)
        dataslice = data.slice(0, index);
        console.log(dataslice)
        d3.select(".annotations").remove();
        d3.select(".chart").selectAll("circle").remove();
        // d3.select("path").remove();
        d3.select(".chart").select(".LineDraw").remove();
        // d3.select(line).remove();
        

        createGraph(dataslice,data,index);
    })

    // add graph updating
    function updateGraph(newdata,data,index) {
        var dat = d3.select(".chart")
        .data(dataslice);
        dat.exit().remove();
        dat.enter()
        .append("g")
        .attr("class","dat")
        .merge(dat)

    }

    // d3.select("svg").select(".chart").remove()
    
    createGraph(dataslice,data,index);
}
</script>

</body>
</html>